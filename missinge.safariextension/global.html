<!--
 - 'Missing e' Extension
 -
 - Copyright 2012, Jeremy Cutler
 - Released under the GPL version 3 licence.
 - SEE: license/GPL-LICENSE.txt
 -
 - This file is part of 'Missing e'.
 -
 - 'Missing e' is free software: you can redistribute it and/or modify
 - it under the terms of the GNU General Public License as published by
 - the Free Software Foundation, either version 3 of the License, or
 - (at your option) any later version.
 -
 - 'Missing e' is distributed in the hope that it will be useful,
 - but WITHOUT ANY WARRANTY; without even the implied warranty of
 - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 - GNU General Public License for more details.
 -
 - You should have received a copy of the GNU General Public License
 - along with 'Missing e'.  If not, see [http://www.gnu.org/licenses/].
-->
<html>
<head>
<script type="text/javascript">
var MissingE = {};
var extension = {isSafari: true};
</script>
<script type="text/javascript" src="lib/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="lib/evalFix.js"></script>
<script type="text/javascript" src="core/localizations.js"></script>
<script type="text/javascript" src="core/utils.js"></script>
<script>
var componentList = ["dashboardTweaks",
                     "bookmarker",
                     "dashLinksToTabs",
                     "safeDash",
                     "timestamps",
                     "magnifier",
                     "betterReblogs",
                     "gotoDashPost",
                     "postingTweaks",
                     "reblogYourself",
                     "askTweaks",
                     "postCrushes",
                     "replyReplies",
                     "massEditor",
                     "sidebarTweaks"];

var maxActiveAjax = 15;
var activeAjax = 0;
var activeRequests = {};
var onHold = {};
var numSleeping = 0;
var waitQueue = [];
var cache = {};
var cacheElements = 0;
var cacheClear;
var clearQueues;
var permissionCache = {};
var askerTable = {};
var askerWaiters = {};
var askerTableCopy = {};
var askerTableClear;
var fiveMinutes = 300000;
var tenSeconds = 10000;
var replies = [];
var crushes = [];
var repliesAndCrushesClear;
var lang = 'en';
var initialStyleSheets = [];
var hasSlimSidebar = false;

function getSetting(key, defVal) {
   var retval = safari.extension.settings[key];
   if (retval === undefined || retval === null || retval === "") {
      return defVal;
   }
   else {
      if (/[^\d]/.test(retval)) {
         return retval;
      }
      else {
         return parseInt(retval, 10);
      }
   }
}

function getVersion() {
   return getSetting("MissingE_version",'');
}

var currVersion = getVersion();
var prevVersion = getSetting('MissingE_installedVersion',null);

function setSetting(key, val) {
   safari.extension.settings[key] = val;
}

repliesAndCrushesClear = setInterval(function() {
   var i;
   for (i=0; i<replies.length; i++) {
      if (replies[i].tab.page === undefined) {
         replies.splice(i,1);
         i--;
      }
   }
   for (i=0; i<crushes.length; i++) {
      if (crushes[i].tab.page === undefined) {
         crushes.splice(i,1);
         i--;
      }
   }
}, fiveMinutes);

askerTableClear = setInterval(function() {
   var i;
   for (i in askerTableCopy) {
      if (askerTableCopy.hasOwnProperty(i) &&
          askerTable.hasOwnProperty(i)) {
         delete askerTable[i];
      }
   }
   askerTableCopy = {};
   for (i in askerTable) {
      if (askerTable.hasOwnProperty(i)) {
         askerTableCopy[i] = true;
      }
   }
}, fiveMinutes);

cacheClear = setInterval(function() {
   cache = {};
   cacheElements = 0;
   permissionCache = {};
}, fiveMinutes);
clearQueues = setInterval(function() {
   if (activeAjax == 0) {
      if (numSleeping !== 0) {
         MissingE.MissingE.debug(numSleeping + " still sleeping");
      }
      if (waitQueue.length > 0) {
         MissingE.debug(waitQueue.length + " still queued");
      }
   }
}, tenSeconds);

function exportOptionsXML(request) {
   request.target.page.dispatchMessage("exportOptions", {url: "http://tools.missing-e.com/settings?" + $.param(createOptionParams())});
}

function isInternalSetting(setting) {
   return !/^MissingE_/.test(setting) ||
          setting === "MissingE_version" ||
          setting === "MissingE_previousVersion" ||
          setting === "MissingE_installedVersion" ||
          /MissingE_externalVersion/.test(setting) ||
          setting === "MissingE_compatCheck" ||
          setting === "MissingE_lastUpdateCheck" ||
          setting === "MissingE_konami_active" ||
          !/^[a-zA-Z0-9_]*$/.test(setting);
}

function createOptionParams() {
   var opts = {};
   for (setting in safari.extension.settings) {
      if (safari.extension.settings.hasOwnProperty(setting) &&
          !isInternalSetting(setting)) {
         opts[setting] = safari.extension.settings[setting];
      }
   }
   return opts;
}

function createOptionString() {
   var i, result = "";
   var opts = createOptionParams();
   for (i in opts) {
      if (opts.hasOwnProperty(i)) {
         result += i + ": \"" + opts[i] + "\"\n";
      }
   }
   return result;
}

function receiveOptions(request) {
   var currSettings = {};
   var changed, set, reset;
   changed = set = reset = 0;
   for (i in safari.extension.settings) {
      if (safari.extension.settings.hasOwnProperty(i)) {
         currSettings[i] = safari.extension.settings[i];
      }
   }
   var settings = request.message.data;
   for (i in settings) {
      if (settings.hasOwnProperty(i)) {
         if (!currSettings.hasOwnProperty(i) ||
             currSettings[i] != settings[i]) {
            var done = false;
            if (typeof safari.extension.settings[i] === "number") {
               var val = parseInt(settings[i]);
               if (!isNaN(val)) {
                  done = true;
                  safari.extension.settings[i] = val;
               }
            }
            else {
               done = true;
               safari.extension.settings[i] = settings[i];
            }
            if (done) {
               var old = "'" + currSettings[i] + "'";
               if (currSettings[i] === undefined) {
                  old = "undefined";
                  set++;
               }
               else {
                  changed++;
               }
               MissingE.debug(i + " [" + old + " => '" + settings[i] + "']");
            }
         }
      }
   }
   for (i in currSettings) {
      if (currSettings.hasOwnProperty(i) &&
          !settings.hasOwnProperty(i) &&
          !isInternalSetting(i)) {
         reset++;
         safari.extension.settings.removeItem(i);
      }
   }
   if (set + changed + reset > 0) {
      fixupSettings();
      alert("Import complete.\n\n" + (set+changed+reset) + " change(s) made.");
      request.target.page.dispatchMessage("importOptions", {success:true});
   }
   else {
      alert("No changes imported.");
      request.target.page.dispatchMessage("importOptions", {success:false});
   }
}

function doTags(stamp, id, request) {
   if (!stamp.tags) {
      MissingE.debug("Cache entry does not have tags");
      return false;
   }
   var tags = stamp.tags;
   if (!tags) {
      tags = [];
   }
   request.target.page.dispatchMessage("tags",{success: true, data: tags});
   return true;
}

function doVimeoPreview(stamp, id, request) {
   var failMsg = {success: true, pid: id,
                  data: [safari.extension.baseURI +
                           'core/dashboardTweaks/black.png'], type: "video"};
   if (!stamp.videoThumbs ||
       stamp.videoThumbs.length !== 1 ||
       !/vimeo:/.test(stamp.videoThumbs[0])) {
      request.target.page.dispatchMessage("preview",failMsg);
      return true;
   }

   var vimeoId = stamp.videoThumbs[0].match(/vimeo:(.*)/)[1];
   $.ajax({
      type: "GET",
      url: "http://vimeo.com/api/v2/video/" + vimeoId + ".json",
      dataType: "json",
      targetId: id,
      error: function(xhr, textStatus) {
         if (xhr.status == 404) {
            MissingE.debug("vimeo request (" + this.targetId + ") not found");
            if (request.target.page !== undefined) {
               request.target.page.dispatchMessage("preview",failMsg);
            }
            return;
         }
         else {
            MissingE.debug("vimeo request (" + this.targetId + ") failed");
            if (request.target.page !== undefined) {
               request.target.page.dispatchMessage("preview",failMsg);
            }
            return;
         }
      },
      success: function(data, textStatus) {
         var theEntry, isNew;
         if (data && data.length > 0) {
            data = data[0];
         }
         if (!data.hasOwnProperty("thumbnail_small")) {
            if (request.target.page !== undefined) {
               request.target.page.dispatchMessage("preview",failMsg);
            }
            return;
         }
         if ((theEntry = cache[id])) {
            MissingE.debug("Saving vimeo thumb " + id + " to cache (HIT)");
            isNew = false;
         }
         else {
            MissingE.debug("Saving vimeo thumb " + id + " to cache (MISS)");
            cacheElements++;
            theEntry = {};
            isNew = false;
         }
         theEntry.videoThumbs = [data.thumbnail_small];
         if (isNew) {
            cache[id] = theEntry;
         }
         if (request.target.page !== undefined) {
            request.target.page.dispatchMessage("preview",
               {success: true, pid: id, data: [data.thumbnail_small],
                type: "video"});
         }
         return;
      }
   });
}


function doNotes(count, id, request) {
   request.target.page.dispatchMessage("notes",
      {success: true, pid: id, data: count});
   return true;
}

function doPreview(stamp, id, request) {
   var i, type;
   if (!stamp.photos && !stamp.videoThumbs) {
      MissingE.debug("Cache entry does not have photos");
      return false;
   }
   var photos = [];
   for (i=0; stamp.photos && i<stamp.photos.length; i++) {
      photos.push(stamp.photos[i].replace(/\d+\.([a-z]+)$/,"100.$1"));
   }
   for (i=0; stamp.videoThumbs && i<stamp.videoThumbs.length; i++) {
      photos.push(stamp.videoThumbs[i]);
   }
   if (photos.length === 0) {
      photos.push(safari.extension.baseURI + 'core/dashboardTweaks/black.png');
   }
   if (/vimeo:/.test(photos[0])) {
      MissingE.debug("Preview image is " + photos[0] + ". Accessing Vimeo API.");
      doVimeoPreview(stamp, id, request);
      return true;
   }
   else {
      request.target.page.dispatchMessage("preview",
         {success: true, pid: id, data: photos, type: request.message.type});
      return true;
   }
}

function doTimestamp(stamp, id, request) {
   if (!stamp.timestamp) {
      MissingE.debug("Cache entry does not have timestamp");
      return false;
   }
   var ts = stamp.timestamp;
   var d = new Date(ts*1000);
   if (isNaN(d)) {
      request.target.page.dispatchMessage("timestamp",{pid: id, success: false});
   }
   var ins = getSetting("MissingE_timestamps_format",MissingE.defaultFormat);
   ins = MissingE.getFormattedDate(d, ins, lang);
   request.target.page.dispatchMessage("timestamp",{pid: id, success: true, data: ins});
   return true;
}

function doReblogDash(stamp, id, request) {
   if (!stamp.reblog_key) {
      MissingE.debug("Cache entry does not have reblog key.");
      return false;
   }
   var key = stamp.reblog_key;
   var name = stamp.name;
   request.target.page.dispatchMessage(request.name,{pid: id, success: true, data: key, name: name});
   return true;
}

function queueAjax(details) {
   waitQueue.push(details);
   MissingE.debug("Queueing " + details.type + " request. " + (waitQueue.length) +
         " in queue");
}

function runItem(call) {
   if (call.type === "reblogYourself") {
      requestReblogYourself(call.request);
   }
   else if (call.type === "betterReblogs") {
      requestBetterReblogsAsk(call.request);
   }
   else if (call.type === "timestamp") {
      requestTimestamp(call.request);
   }
   else if (call.type === "tags") {
      requestTags(call.request);
   }
   else if (call.type === "preview") {
      requestPreview(call.request);
   }
   else if (call.type === "notes") {
      requestNotes(call.request);
   }
}

function dequeueAjax(id) {
   if (id) {
      activeAjax--;
      wakeById(id);
      delete activeRequests[id];
   }
   while (activeAjax < maxActiveAjax) {
      var call = waitQueue.shift();
      if (!call) { return false; }
      MissingE.debug("Dequeueing " + call.type + " request. " + (waitQueue.length) +
            " in queue");
      runItem(call);
   }
}

function saveCache(id, entry) {
   var theEntry;
   var isNew = true;
   if ((theEntry = cache[id])) {
      MissingE.debug("Saving " + id + " to cache (HIT)");
      isNew = false;
   }
   else {
      MissingE.debug("Saving " + id + " to cache (MISS)");
      cacheElements++;
      theEntry = {};
   }
   for (var i in entry) {
      if (entry.hasOwnProperty(i)) {
         if (i == "photos" ||
             i == "timestamp" ||
             i == "reblog_key" ||
             i == "post_url" ||
             i == "tags" ||
             i == "type" ||
             i == "publishStamp" ||
             (i == "name" && entry[i] != "")) {
            theEntry[i] = entry[i];
         }
         else if (i == "videoThumbs" &&
                  !theEntry.hasOwnProperty(i)) {
            theEntry[i] = entry[i];
         }
      }
   }
   if (isNew) {
      cache[id] = theEntry;
   }
}

function cacheServe(type, id, request, fn, midFlight, notAjax) {
   var entry;
   if ((entry = cache[id])) {
      MissingE.debug(type + " request (" + id + ") has cache entry.");
      if (midFlight && !notAjax) {
         dequeueAjax(id);
      }
      else if (!notAjax) {
         dequeueAjax();
      }
      return fn(entry, id, request);
   }
   else {
      return false;
   }
}

function wakeById(id) {
   var i,j;
   for (i=0; activeRequests[id] && i<activeRequests[id].length; i++) {
      var call;
      if ((call = activeRequests[id][i])) {
         delete onHold[call.type + call.request.message.pid];
         numSleeping--;
         MissingE.debug("Selectively waking " + call.type + " request (" + call.request.message.pid + "). " + numSleeping + " still asleep");
         runItem(call);
      }
   }
}

function isRequested(details) {
   var bucket;
   if (!details.request.sleepCount) {
      details.request.sleepCount = 0;
   }
   if ((bucket = activeRequests[details.request.message.pid]) &&
       details.request.sleepCount < 5) {
      onHold[details.type + details.request.message.pid] = details;
      bucket.push(details);
      numSleeping++;
      details.request.sleepCount++;
      MissingE.debug("Sleeping " + details.type + " request (" +
            details.request.message.pid + ") [" + details.request.sleepCount +
            "]. " + numSleeping + " asleep");
      return true;
   }
   else {
      return false;
   }
}

function startAjax(id) {
   activeAjax++;
   if (!activeRequests.hasOwnProperty(id)) {
      activeRequests[id] = [];
   }
}

function doAskAjax(request, retries, type, doFunc) {
   MissingE.debug("AJAX " + type + " request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false, pid: request.message.pid};
   $.ajax({
      type: "GET",
      url: request.message.url + request.message.pid,
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status == 404) {
            MissingE.debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage(type,failMsg);
            return;
         }
         if (request.target.page === undefined) {
            MissingE.debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.message.pid, request, doFunc, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               MissingE.debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               MissingE.debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type, failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         if (!(/<input[^>]*name="post\[date\]"[^>]*>/.test(data))) {
            if (request.target.page === undefined) {
               MissingE.debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.message.pid, request, doFunc, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  MissingE.debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  MissingE.debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage(type,failMsg);
               }
            }
         }
         else {
            var failed = false;
            var txt;
            var inp = data.match(/<input[^>]*name="post\[date\]"[^>]*>/);
            if (!inp) { failed = true; }
            else {
               txt = inp[0].match(/value="([^"]*)"/);
               if (!txt || txt.length < 2) {
                  failed = true;
               }
               else {
                  txt = txt[1];
               }
            }
            if (failed) {
               MissingE.debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type,failMsg);
               return;
            }

            var stamp = MissingE.buildTimestamp(txt);

            var info = {"timestamp":stamp};
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (!closed) {
               doFunc(info, this.targetId, request);
            }
         }
      }
   });
}

function checkPermission(request, retries, tryCount) {
   if (permissionCache.hasOwnProperty(request.message.user)) {
      request.target.page.dispatchMessage("tumblrPermission",
                              {allow: permissionCache[request.message.user]});
      return;
   }
   var ajax = new XMLHttpRequest();
   ajax.open("HEAD", "http://www.tumblr.com/blog/" +
             request.message.user, true);
   if (!tryCount) { tryCount = 0; }
   ajax.onreadystatechange = function() {
      if (request.target.page === undefined) {
         return;
      }
      else if (this.readyState == 4) {
         if (this.status == 200) {
            permissionCache[request.message.user] = true;
            request.target.page.dispatchMessage("tumblrPermission",
                                                {allow: true});
         }
         else if (this.status < 500) {
            permissionCache[request.message.user] = false;
            request.target.page.dispatchMessage("tumblrPermission",
                                                {allow:false});
         }
         else {
            tryCount++;
            if (tryCount <= retries) {
               checkPermission(request, sender, sendResponse, hash, retries,
                               tryCount);
               return;
            }
            else {
               request.target.page.dispatchMessage("tumblrPermission",
                                                   {allow:false});
            }
         }
      }
   };
   ajax.send();
}

function parseRSS(data, forceType) {
   var info = {};
   var i;
   var tags = data.match(/<category>[^<]*<\/category>/g);
   if (!tags) { tags = []; }
   for (i=0; i<tags.length; i++) {
      tags[i] = tags[i].replace(/^<category>/,'')
                     .replace(/<\/category>$/,'');
   }
   info.tags = tags;

   var pubTime = data.match(/<pubDate>([^<]*)<\/pubDate>/);
   if (pubTime && pubTime.length > 1) {
      info.publishStamp = (new Date(pubTime[1])).valueOf()/1000;
   }

   var photos = [];
   var desc = data.match(/<description>&lt;img[^<]*/);
   if (desc) {
      desc = desc[0].replace(/^<description>/,'');
      while (/^&lt;img/.test(desc)) {
         var img = desc.match(/src="([^"]*)"/);
         if (img && img.length > 1) {
            photos.push(img[1].replace(/http:\/\/[0-9]+\./,'http://'));
         }
         desc = desc.replace(/^&lt;img[^&]*(&gt;|[^&]+)+/,'');
         desc = desc.replace(/^(&lt;br\/&gt;|\s)+/,'');
      }
   }
   if (photos.length > 0) {
      info.photos = photos;
   }

   var videoThumbs = [];
   var youtube = data.match(/<description>&lt;iframe[^&]*src="http:\/\/www\.youtube\.com\/embed\/([^\/\?]*)/);
   var vimeo = data.match(/<description>&lt;iframe[^&]*src="http:\/\/player.vimeo.com\/video\/([^\/\?"'%]*)/);
   var tumblr;
   if (/<description>&lt;span id="video_player/.test(data)) {
      tumblr = data.match(/poster=(http[^'"\(\)&]*)/);
      tumblr = tumblr[0].replace(/poster=/,'').split(',');
   }
   if (youtube && youtube.length > 1) {
      for (i=0; i<=3; i++) {
         videoThumbs.push('http://img.youtube.com/vi/' + youtube[1] + '/' +
                               i + '.jpg');
      }
   }
   else if (vimeo && vimeo.length > 1) {
      videoThumbs.push('vimeo:' + vimeo[1]);
   }
   else if (tumblr && tumblr.length > 1) {
      for (i=1; i<tumblr.length; i++) {
         videoThumbs.push(tumblr[i].replace(/%3A/gi,':').replace(/%2F/gi,'/'));
      }
   }
   if (videoThumbs.length > 0 || forceType === "video") {
      info.videoThumbs = videoThumbs;
   }

   return info;
}

function doTagsAjax(request, retries) {
   MissingE.debug("AJAX tags request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false, pid:request.message.pid};
   $.ajax({
      type: "GET",
      url: request.message.url + "/post/" + request.message.pid + "/rss",
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            MissingE.debug("tags request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage("tags",failMsg);
            return;
         }
         if (request.target.page === undefined) {
            MissingE.debug("Stop tags request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe("tags", request.message.pid, request, doTags, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               MissingE.debug("Retry tags request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               MissingE.debug("tags request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage("tags",failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         if (!(/<guid>[^<]*<\/guid>/.test(data))) {
            if (request.target.page === undefined) {
               MissingE.debug("Stop tags request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe("tags", request.message.pid, request, doTags, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  MissingE.debug("Retry tags request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  MissingE.debug("tags request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage("tags",failMsg);
               }
            }
         }
         else {
            var info = parseRSS(data);
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (request.target.page !== undefined) {
               doTags(info, this.targetId, request);
            }
         }
      }
   });
}

function doNotesAjaxMultiStep(request, retries) {
   MissingE.debug("AJAX notes 1st request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false, pid:request.message.pid};
   $.ajax({
      type: "GET",
      url: request.message.url + "/post/" + request.message.pid + "/rss",
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            MissingE.debug("notes 1st request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage("notes",failMsg);
            return;
         }
         if (request.target.page === undefined) {
            MissingE.debug("Stop notes 1st request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (!cacheServe("notes 1st", request.message.pid, request,
                         function(){return true;}, true)) {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               MissingE.debug("Retry notes 1st request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               MissingE.debug("notes 1st request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage("notes",failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         if (!(/<guid>[^<]*<\/guid>/.test(data))) {
            if (request.target.page === undefined) {
               MissingE.debug("Stop notes 1st request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (!cacheServe("notes 1st", request.message.pid, request,
                            function(){return true;}, true)) {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  MissingE.debug("Retry notes 1st request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  MissingE.debug("notes 1st request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage("notes",failMsg);
               }
            }
         }
         else {
            var info = parseRSS(data, request.message.type);
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (request.target.page !== undefined) {
               doNotesAjax(request, retries);
            }
         }
      }
   });
}

function doNotesAjax(request, retries) {
   if (!cache.hasOwnProperty(request.message.pid) ||
       !cache[request.message.pid].hasOwnProperty("publishStamp")) {
      doNotesAjaxMultiStep(request, retries);
      return;
   }
   MissingE.debug("AJAX notes request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false, pid:request.message.pid};
   $.ajax({
      type: "GET",
      url: request.message.url + "/archive?before_time=" +
            (cache[request.message.pid].publishStamp+1),
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            MissingE.debug("notes request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage("notes",failMsg);
            return;
         }
         if (request.target.page === undefined) {
            MissingE.debug("Stop notes request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         this.tryCount++;
         if (this.tryCount <= this.retryLimit) {
            MissingE.debug("Retry notes request (" + this.targetId + ")");
            $.ajax(this);
            return;
         }
         else {
            MissingE.debug("notes request (" + this.targetId + ") failed");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage("notes",failMsg);
         }
      },
      success: function(data, textStatus) {
         data = data.replace(/\n/g,' ');
         var re = new RegExp('< *a [^>]*id="post_' + this.targetId + '".*<\/a>');
         var postInfo = re.exec(data);
         if (!postInfo) {
            if (request.target.page === undefined) {
               MissingE.debug("Stop notes request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               MissingE.debug("Retry notes request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               MissingE.debug("notes request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage("notes",failMsg);
            }
         }
         else {
            var noteCount = postInfo[0].match(/<\s*div\s+class="notes"\s*>[^<\d]*([\d\., ]+)[^<\d]*/);
            if (!noteCount || noteCount.length < 2) {
               noteCount = "";
            }
            else {
               noteCount = noteCount[1];
            }
            noteCount = noteCount.replace(/^\s+/,'').replace(/\s+$/,'').replace(/\s/g,',');
            dequeueAjax(this.targetId);
            if (request.target.page !== undefined) {
               doNotes(noteCount, this.targetId, request);
            }
         }
      }
   });
}

function doPreviewAjax(request, retries) {
   MissingE.debug("AJAX preview request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false, pid:request.message.pid,
                  type: request.message.type};
   $.ajax({
      type: "GET",
      url: request.message.url + "/post/" + request.message.pid + "/rss",
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            MissingE.debug("preview request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage("preview",failMsg);
            return;
         }
         if (request.target.page === undefined) {
            MissingE.debug("Stop tags request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe("preview", request.message.pid, request, doPreview, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               MissingE.debug("Retry preview request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               MissingE.debug("preview request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage("preview",failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         if (!(/<guid>[^<]*<\/guid>/.test(data))) {
            if (request.target.page === undefined) {
               MissingE.debug("Stop preview request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe("preview", request.message.pid, request, doPreview, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  MissingE.debug("Retry preview request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  MissingE.debug("preview request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage("preview",failMsg);
               }
            }
         }
         else {
            var info = parseRSS(data, request.message.type);
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (request.target.page !== undefined) {
               doPreview(info, this.targetId, request);
            }
         }
      }
   });
}

function doReblogAjax(type, request, retries, additional) {
   MissingE.debug("AJAX " + type + " request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false, pid:request.message.pid};
   if (additional) {
      for (i in additional) {
         if (additional.hasOwnProperty(i)) {
            failMsg[i] = additional[i];
         }
      }
   }
   $.ajax({
      type: "GET",
      url: request.message.url,
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            MissingE.debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage(type,failMsg);
            return;
         }
         if (request.target.page === undefined) {
            MissingE.debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.message.pid, request, doReblogDash, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               MissingE.debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               MissingE.debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type,failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         var ifr = data.match(/<\s*iframe[^>]*id="tumblr_controls"[^>]*>/);
         if (!ifr || ifr.length === 0) {
            if (request.target.page === undefined) {
               MissingE.debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.message.pid, request, doReblogDash, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  MissingE.debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  MissingE.debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage(type,failMsg);
               }
            }
         }
         else {
            var rk = ifr[0].match(/rk=([^&"']*)/);
            var poster = ifr[0].match(/name=([^&"']*)/);
            var user;
            if (rk && rk.length > 1) {
               if (!poster || poster.length <= 1) {
                  user = "";
               }
               else {
                  user = poster[1];
               }
               var info = {"reblog_key":rk[1],
                           "name":user};
               saveCache(this.targetId, info);
               dequeueAjax(this.targetId);
               if (request.target.page !== undefined) {
                  doReblogDash(info, this.targetId, request);
               }
            }
            else if (request.target.page !== undefined) {
               MissingE.debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type,failMsg);
            }
         }
      }
   });
}

function requestTags(request) {
   if (request.target.page === undefined) {
      MissingE.debug("Stop tags request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("tags", request.message.pid, request, doTags,
                  false)) {
      return true;
   }
   else if (isRequested({type: "tags", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "tags", request: request});
   }
   else {
      doTagsAjax(request,
             getSetting("MissingE_betterReblogs_retries",MissingE.defaultRetries));
   }
}

function requestNotes(request, sender, sendResponse, hash) {
   if (request.target.page === undefined) {
      MissingE.debug("Stop notes request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "notes", request: request});
   }
   else {
      doNotesAjax(request,
                  getSetting("MissingE_dashboardTweaks_previewRetries",MissingE.defaultRetries));
   }
}

function requestPreview(request) {
   if (request.target.page === undefined) {
      MissingE.debug("Stop preview request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("preview", request.message.pid, request, doPreview,
                  false)) {
      return true;
   }
   else if (isRequested({type: "preview", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "preview", request: request});
   }
   else {
      doPreviewAjax(request,
             getSetting("MissingE_dashboardTweaks_previewRetries",MissingE.defaultRetries));
   }
}

function requestTimestamp(request) {
   if (request.message.lang) { lang = request.message.lang; }
   if (request.target.page === undefined) {
      MissingE.debug("Stop timestamp request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("timestamp", request.message.pid, request, doTimestamp,
                  false)) {
      return true;
   }
   else if (isRequested({type: "timestamp", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "timestamp", request: request});
   }
   else if (request.message.url === 'http://www.tumblr.com/edit/') {
      doAskAjax(request,
                getSetting("MissingE_timestamps_retries",MissingE.defaultRetries),
                "timestamp", doTimestamp);
   }
}

function requestBetterReblogsAsk(request) {
   if (request.target.page === undefined) {
      MissingE.debug("Stop betterReblogs request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("betterReblogs", request.message.pid, request,
                  doReblogDash, false)) {
      return true;
   }
   else if (isRequested({type: "betterReblogs", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "betterReblogs", request: request});
   }
   else {
      doReblogAjax("betterReblogs",request,
             getSetting("MissingE_betterReblogs_askRetries",MissingE.defaultRetries),
             { pid:request.pid });
   }
}

function requestReblogYourself(request) {
   if (request.target.page === undefined) {
      MissingE.debug("Stop reblogYourself request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("reblogYourself", request.message.pid, request,
                  doReblogDash, false)) {
      return true;
   }
   else if (isRequested({type: "reblogYourself", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "reblogYourself", request: request});
   }
   else {
      doReblogAjax("reblogYourself", request,
             getSetting("MissingE_reblogYourself_retries",MissingE.defaultRetries),
             { pid:request.pid });
   }
}

function requestMagnifier(request) {
   if (request.target.page === undefined) {
      MissingE.debug("Stop magnifier request: Tab closed or changed.");
      return;
   }
   else {
      if (!request.message.hasOwnProperty('src')) {
         request.target.page.dispatchMessage("magnifier", {pid: request.message.pid,
                                                           success: false});
      }
      else {
         var ft = request.message.src.match(/\.[a-z]{2,4}$/i);
         var fullsrc = request.message.src.replace(/_\d+\.[a-z]{2,4}$/i,'_1280'+ft);

         var ajax = new XMLHttpRequest();
         ajax.open("HEAD", fullsrc, true);
         ajax.onreadystatechange = function() {
            if (this.readyState == 4) {
               if (this.status == 200) {
                  request.target.page.dispatchMessage("magnifier",
                     {pid: request.message.pid, success:true, data: fullsrc});
               }
               else {
                  request.target.page.dispatchMessage("magnifier",
                     {pid: request.message.pid, success:true, data: request.message.src});
               }
            }
         };
         ajax.send();
      }
   }
}

function closeTab(url, currentTab) {
   var i,j;
   var windows = safari.application.browserWindows;
   for (i=0; i<windows.length; i++) {
      for (j=0; j<windows[i].tabs.length; j++) {
         var thisURL = windows[i].tabs[j].url.replace(/#.*$/,'');
         if (thisURL === url &&
             windows[i].tabs[j] !== currentTab) {
            windows[i].tabs[j].close();
         }
      }
   }
}

function getTabLocation(tab) {
   var i, winIdx = -1, tabIdx = -1;
   for (i=0; i<safari.application.browserWindows.length; i++) {
      if (safari.application.browserWindows[i] === tab.browserWindow) {
         winIdx = i;
         break;
      }
   }
   if (winIdx < 0) { return {windowId: -1, tabId: -1}; }
   for (i=0; i<safari.application.browserWindows[winIdx].tabs.length; i++) {
      if (safari.application.browserWindows[winIdx].tabs[i] === tab) {
         tabIdx = i;
         break;
      }
   }
   if (tabIdx < 0) { return {windowId: winIdx, tabId: -1}; }
   return {windowId: winIdx, tabId: tabIdx};
}

safari.application.addEventListener("command", performCommand, false);
function performCommand(cmd) {
   if (cmd.command == "missinge-settings") {
      cmd.target.browserWindow.openTab().url = safari.extension.baseURI + "core/options.html"
   }
}

safari.application.addEventListener("message", handleRequest, false);
function handleRequest(request) {
   if (request.name == "open") {
      var theurl;
      if (typeof request.message === "string") {
         theurl = request.message;
      }
      else {
         theurl = request.message.url;
      }
      request.target.browserWindow.openTab().url = theurl;
   }
   else if (request.name == "updatedCheck") {
      request.target.page.dispatchMessage("updatedCheck",
         {uptodate:(MissingE.versionCompare(getSetting("MissingE_version",'0'),
                    request.message.v) >= 0)});
   }
   else if (request.name == "getOptions") {
      request.target.page.dispatchMessage("getOptions",
         {options: createOptionString()});
   }
   else if (request.name == "getExtensionInfo") {
      request.target.page.dispatchMessage("getExtensionInfo",
         {info:{ version: getSetting("MissingE_version",'0') }});
   }
   else if (request.name == "exportOptions") {
      exportOptionsXML(request);
   }
   else if (request.name == "importOptions") {
      receiveOptions(request);
   }
   else if (request.name == "getAsker") {
      if (askerTable[request.target.url]) {
         MissingE.debug("Found saved asker for '" + request.target.url + "'");
         var name = askerTable[request.target.url].asker;
         var isSure = askerTable[request.target.url].isSure;
         if (--askerTable[request.target.url].count == 0) {
            MissingE.debug("Deleting saved asker for '" + request.target.url + "'");
            delete askerTable[request.target.url];
         }
         if (name && name !== "") {
            request.target.page.dispatchMessage("sendAsker",
               {name: name, isSure: isSure, url: request.target.url});
         }
      }
      else {
         if (askerWaiters[request.target.url]) {
            MissingE.debug("Creating new askerWaiter for '" + request.target.url + "'");
            askerWaiters[request.target.url].push(request);
         }
         else {
            MissingE.debug("Adding askerWaiter for '" + request.target.url + "'");
            askerWaiters[request.target.url] = [request];
         }
      }
   }
   else if (request.name == "sendAsker") {
      if (askerWaiters[request.target.url]) {
         MissingE.debug("Found existing askerWaiter for '" + request.target.url + "'");
         var r = askerWaiters[request.target.url].pop();
         if (askerWaiters[request.target.url].length === 0) {
            MissingE.debug("Deleting existing askerWaiter queue for '" + request.target.url + "'");
            delete askerWaiters[request.target.url];
         }
         if (request.message.name && request.message.name !== "") {
            r.target.page.dispatchMessage("sendAsker",
               {name: request.message.name, isSure: request.message.isSure,
                url: request.target.url});
         }
      }
      else {
         if (askerTable[request.target.url]) {
            MissingE.debug("Found existing askerTable entry for '" + request.target.url + "'");
            askerTable[request.target.url].count++;
         }
         else {
            MissingE.debug("Creating askerTable entry for '" + request.target.url + "'");
            askerTable[request.target.url] = {asker: request.message.name,
                                              isSure: request.message.isSure, count:1};
         }
      }
   }
   else if (request.name == "uploader") {
      MissingE.debug("Getting form key");
      $.ajax({
         url: "http://www.tumblr.com/upload/image",
         dataType:"html",
         retries:4,
         tryCount:0,
         success:function(data) {
            var key = data.match(/<input[^>]*name="form_key"[^>]*value="([^"]*)"[^>]*>/);
            if (!key || key.length < 2) {
               MissingE.debug("Retrying form key retrieval");
               if (this.tryCount < this.retries) {
                  this.tryCount++;
                  $.ajax(this);
               }
               else {
                  MissingE.debug("Form key retrieval failed");
                  request.target.page.dispatchMessage("uploader",{success: false});
               }
            }
            else {
               request.target.page.dispatchMessage("uploader",{success: true, data: key[1]});
            }
         },
         error:function() {
            if (this.tryCount < this.retries) {
               MissingE.debug("Retrying form key retrieval");
               this.tryCount++;
               $.ajax(this);
            }
            else {
               MissingE.debug("Failed form key retrieval");
               request.target.page.dispatchMessage("uploader",{success: false});
            }
         }
      });
   }
   else if (request.name == "update") {
      request.target.page.dispatchMessage("update", {update:
         MissingE.versionCompare(getSetting("MissingE_externalVersion",'0'),
                                 getSetting("MissingE_version",'0')) > 0});
   }
   else if (request.name == "close-options") {
      closeTab(request.target.url, request.target);
   }
   else if (request.name == "magnifier") {
      requestMagnifier(request);
   }
   else if (request.name == "notes") {
      requestNotes(request);
   }
   else if (request.name == "preview") {
      requestPreview(request);
   }
   else if (request.name == "reblogYourself") {
      requestReblogYourself(request);
   }
   else if (request.name == "betterReblogs") {
      requestBetterReblogsAsk(request);
   }
   else if (request.name == "tags") {
      requestTags(request);
   }
   else if (request.name == "timestamp") {
      if (request.message.type == "ask") {
         requestTimestamp(request);
      }
      else if (cacheServe("timestamp", request.message.pid, request, doTimestamp, false, true)) {
         return true;
      }
      else {
         MissingE.debug("Building timestamp (" + request.message.pid + ")");
         var ts = MissingE.buildTimestamp(request.message.stamp);
         if (ts !== null) {
            var info = {"timestamp":ts};
            saveCache(request.message.pid,info);
            doTimestamp(info, request.message.pid, request);
         }
         else {
            request.target.page.dispatchMessage("timestamp",
                                                {pid: id, success: false});
         }
      }
   }
   else if (request.name == "tags") {
      requestTags(request);
   }
   else if (request.name == "sendCrushes") {
      if (getSetting("MissingE_postCrushes_newTab",1) === 1) {
         var tabLoc = getTabLocation(request.target);
         var newTab = safari.application.browserWindows[tabLoc.windowId]
                        .openTab("foreground", (tabLoc.tabId+1));
         crushes.push({tab: newTab, img: request.message.img,
                       tags: request.message.tags});
         newTab.url = request.message.url;
      }
      else {
         crushes.push({tab: request.target, img: request.message.img,
                       tags: request.message.tags});
         request.target.url = request.message.url;
      }
   }
   else if (request.name == "getCrushes") {
      var i;
      for (i=0; i<crushes.length; i++) {
         if (crushes[i].tab === request.target) {
            request.target.page.dispatchMessage("getCrushes",
                                                {img: crushes[i].img,
                                                 tags: crushes[i].tags});
            crushes.splice(i,1);
            break;
         }
      }
   }
   else if (request.name == "sendReply") {
      if (request.message.newReply &&
          getSetting("MissingE_replyReplies_newTab",1) === 1) {
         var tabLoc = getTabLocation(request.target);
         var newTab = safari.application.browserWindows[tabLoc.windowId]
                        .openTab("foreground", (tabLoc.tabId+1));
         replies.push({tab: newTab, reply: request.message.reply,
                        tags: request.message.tags});
         newTab.url = request.message.url;
      }
      else {
         replies.push({tab: request.target, reply: request.message.reply,
                       tags: request.message.tags});
         request.target.url = request.message.url;
      }
   }
   else if (request.name == "getReply") {
      var i;
      for (i=0; i<replies.length; i++) {
         if (replies[i].tab === request.target) {
            request.target.page.dispatchMessage("getReply",
                                                {reply: replies[i].reply,
                                                 tags: replies[i].tags});
            replies.splice(i,1);
            break;
         }
      }
   }
   else if (request.name == "change-setting") {
      setSetting(request.message.name, request.message.val);
   }
   else if (request.name == "backupVal") {
      setSetting(request.message.key, request.message.val);
   }
   else if (request.name == "getBackupVal") {
      request.target.page.dispatchMessage("getBackupVal", {key: request.message.key, val: getSetting(request.message.key)});
   }
   else if (request.name == "all-settings") {
      var settings = {};
      for (i=0; i<componentList.length; i++) {
         settings["MissingE_" + componentList[i] + "_enabled"] = getSetting("MissingE_" + componentList[i] + "_enabled", 1);
      }
      settings.MissingE_massEditor_showNotes = getSetting("MissingE_massEditor_showNotes",1);
      settings.MissingE_safeDash_photosetAll = getSetting("MissingE_safeDash_photosetAll",0);
      settings.MissingE_safeDash_keyboardShortcut = getSetting("MissingE_safeDash_keyboardShortcut",1);
      settings.MissingE_askTweaks_scroll = getSetting("MissingE_askTweaks_scroll",1);
      settings.MissingE_askTweaks_betterAnswers = getSetting("MissingE_askTweaks_betterAnswers",0);
      settings.MissingE_askTweaks_tagAsker = getSetting("MissingE_askTweaks_tagAsker",1);
      settings.MissingE_askTweaks_defaultTags = getSetting("MissingE_askTweaks_defaultTags",'');
      settings.MissingE_askTweaks_askDash = getSetting("MissingE_askTweaks_askDash",0);
      settings.MissingE_askTweaks_massDelete = getSetting("MissingE_askTweaks_massDelete",1);
      settings.MissingE_askTweaks_smallFanMail = getSetting("MissingE_askTweaks_smallFanMail",0);
      settings.MissingE_askTweaks_allFanMail = getSetting("MissingE_askTweaks_allFanMail",0);
      settings.MissingE_askTweaks_photoReplies = getSetting("MissingE_askTweaks_photoReplies",1);
      settings.MissingE_askTweaks_submissionControls = getSetting("MissingE_askTweaks_submissionControls",1);
      settings.MissingE_bookmarker_format = getSetting("MissingE_bookmarker_format",MissingE.defaultFormat);
      settings.MissingE_bookmarker_addBar = getSetting("MissingE_bookmarker_addBar",1);
      settings.MissingE_bookmarker_keyboardShortcut = getSetting("MissingE_bookmarker_keyboardShortcut",1);
      settings.MissingE_dashboardTweaks_reblogQuoteFit = getSetting("MissingE_dashboardTweaks_reblogQuoteFit",1);
      settings.MissingE_dashboardTweaks_wrapTags = getSetting("MissingE_dashboardTweaks_wrapTags",1);
      settings.MissingE_dashboardTweaks_replaceIcons = getSetting("MissingE_dashboardTweaks_replaceIcons",1);
      settings.MissingE_dashboardTweaks_textControls = getSetting("MissingE_dashboardTweaks_textControls",0);
      settings.MissingE_dashboardTweaks_smallIcons = getSetting("MissingE_dashboardTweaks_smallIcons",0);
      settings.MissingE_dashboardTweaks_postLinks = getSetting("MissingE_dashboardTweaks_postLinks",1);
      settings.MissingE_dashboardTweaks_reblogReplies = getSetting("MissingE_dashboardTweaks_reblogReplies",0);
      settings.MissingE_dashboardTweaks_widescreen = getSetting("MissingE_dashboardTweaks_widescreen",0);
      settings.MissingE_dashboardTweaks_queueArrows = getSetting("MissingE_dashboardTweaks_queueArrows",1);
      settings.MissingE_dashboardTweaks_noExpandAll = getSetting("MissingE_dashboardTweaks_noExpandAll",0);
      settings.MissingE_dashboardTweaks_massDelete = getSetting("MissingE_dashboardTweaks_massDelete",1);
      settings.MissingE_dashboardTweaks_randomQueue = getSetting("MissingE_dashboardTweaks_randomQueue",1);
      settings.MissingE_dashboardTweaks_sortableNotes = getSetting("MissingE_dashboardTweaks_sortableNotes",1);
      settings.MissingE_dashboardTweaks_notePreview = getSetting("MissingE_dashboardTweaks_notePreview",1);
      settings.MissingE_dashboardTweaks_previewRetries = getSetting("MissingE_dashboardTweaks_previewRetries",MissingE.defaultRetries);
      settings.MissingE_dashboardTweaks_simpleHighlight = getSetting("MissingE_dashboardTweaks_simpleHighlight",0);
      settings.MissingE_dashboardTweaks_pagedNav = getSetting("MissingE_dashboardTweaks_pagedNav",0);
      settings.MissingE_dashboardTweaks_keyboardShortcut = getSetting("MissingE_dashboardTweaks_keyboardShortcut",1);
      settings.MissingE_sidebarTweaks_retries = getSetting("MissingE_sidebarTweaks_retries",MissingE.defaultRetries);
      settings.MissingE_sidebarTweaks_addSidebar = getSetting("MissingE_sidebarTweaks_addSidebar",0);
      settings.MissingE_sidebarTweaks_slimSidebar = getSetting("MissingE_sidebarTweaks_slimSidebar",0);
      settings.MissingE_sidebarTweaks_showTags = getSetting("MissingE_sidebarTweaks_showTags",0);
      settings.MissingE_magnifier_magnifyAvatars = getSetting("MissingE_magnifier_magnifyAvatars",0);
      settings.MissingE_dashLinksToTabs_newPostTabs = getSetting("MissingE_dashLinksToTabs_newPostTabs",1);
      settings.MissingE_dashLinksToTabs_sidebar = getSetting("MissingE_dashLinksToTabs_sidebar",0);
      settings.MissingE_dashLinksToTabs_reblogLinks = getSetting("MissingE_dashLinksToTabs_reblogLinks",0);
      settings.MissingE_dashLinksToTabs_editLinks = getSetting("MissingE_dashLinksToTabs_editLinks",0);
      settings.MissingE_timestamps_retries = getSetting("MissingE_timestamps_retries",MissingE.defaultRetries);
      settings.MissingE_timestamps_format = getSetting("MissingE_timestamps_format",MissingE.defaultFormat);
      settings.MissingE_postingTweaks_photoReplies = getSetting("MissingE_postingTweaks_photoReplies",1);
      settings.MissingE_postingTweaks_addUploader = getSetting("MissingE_postingTweaks_addUploader",1);
      settings.MissingE_postingTweaks_quickButtons = getSetting("MissingE_postingTweaks_quickButtons",1);
      settings.MissingE_postingTweaks_blogSelect = getSetting("MissingE_postingTweaks_blogSelect",0);
      settings.MissingE_postingTweaks_subEdit = getSetting("MissingE_postingTweaks_subEdit",1);
      settings.MissingE_postingTweaks_subEditRetries = getSetting("MissingE_postingTweaks_subEditRetries",MissingE.defaultRetries);
      settings.MissingE_postingTweaks_tagQueuedPosts = getSetting("MissingE_postingTweaks_tagQueuedPosts",0);
      settings.MissingE_postingTweaks_queueTags = getSetting("MissingE_postingTweaks_queueTags",'');
      settings.MissingE_postingTweaks_showAnswers = getSetting("MissingE_postingTweaks_showAnswers",0);
      settings.MissingE_postingTweaks_facebookOff = getSetting("MissingE_postingTweaks_facebookOff",0);
      settings.MissingE_postingTweaks_smartRedirect = getSetting("MissingE_postingTweaks_smartRedirect",0);
      settings.MissingE_reblogYourself_postPage = getSetting("MissingE_reblogYourself_postPage",1);
      settings.MissingE_reblogYourself_dashboard = getSetting("MissingE_reblogYourself_dashboard",1);
      settings.MissingE_reblogYourself_retries = getSetting("MissingE_reblogYourself_retries",MissingE.defaultRetries);
      settings.MissingE_postCrushes_prefix = getSetting("MissingE_postCrushes_prefix","Tumblr Crushes:");
      settings.MissingE_postCrushes_crushSize = getSetting("MissingE_postCrushes_crushSize",1);
      settings.MissingE_postCrushes_addTags = getSetting("MissingE_postCrushes_addTags",1);
      settings.MissingE_postCrushes_showPercent = getSetting("MissingE_postCrushes_showPercent",1);
      settings.MissingE_postCrushes_newTab = getSetting("MissingE_postCrushes_newTab",1);
      settings.MissingE_replyReplies_showAvatars = getSetting("MissingE_replyReplies_showAvatars",1);
      settings.MissingE_replyReplies_smallAvatars = getSetting("MissingE_replyReplies_smallAvatars",1);
      settings.MissingE_replyReplies_addTags = getSetting("MissingE_replyReplies_addTags",1);
      settings.MissingE_replyReplies_defaultTags = getSetting("MissingE_replyReplies_defaultTags",'');
      settings.MissingE_replyReplies_newTab = getSetting("MissingE_replyReplies_newTab",1);
      settings.MissingE_betterReblogs_passTags = getSetting("MissingE_betterReblogs_passTags",1);
      settings.MissingE_betterReblogs_retries = getSetting("MissingE_betterReblogs_retries",MissingE.defaultRetries);
      settings.MissingE_betterReblogs_autoFillTags = getSetting("MissingE_betterReblogs_autoFillTags",1);
      settings.MissingE_betterReblogs_quickReblog = getSetting("MissingE_betterReblogs_quickReblog",0);
      settings.MissingE_betterReblogs_quickReblogAcctType = getSetting("MissingE_betterReblogs_quickReblogAcctType",0);
      settings.MissingE_betterReblogs_quickReblogAcctName = getSetting("MissingE_betterReblogs_quickReblogAcctName",'');
      settings.MissingE_betterReblogs_quickReblogForceTwitter = getSetting("MissingE_betterReblogs_quickReblogForceTwitter","default");
      settings.MissingE_betterReblogs_quickReblogForceFacebook = getSetting("MissingE_betterReblogs_quickReblogForceFacebook","default");
      settings.MissingE_betterReblogs_quickReblogCaption = getSetting("MissingE_betterReblogs_quickReblogCaption",1);
      settings.MissingE_betterReblogs_fullText = getSetting("MissingE_betterReblogs_fullText",0);
      settings.MissingE_betterReblogs_reblogAsks = getSetting("MissingE_betterReblogs_reblogAsks",0);
      settings.MissingE_betterReblogs_tagReblogs = getSetting("MissingE_betterReblogs_tagReblogs",0);
      settings.MissingE_betterReblogs_reblogTags = getSetting("MissingE_betterReblogs_reblogTags",'');
      settings.MissingE_betterReblogs_quickKeyboardShortcut = getSetting("MissingE_betterReblogs_quickKeyboardShortcut",1);
      settings.MissingE_betterReblogs_askRetries = getSetting("MissingE_betterReblogs_askRetries",MissingE.defaultRetries);
      settings.MissingE_version = getSetting("MissingE_version",'');
      settings.MissingE_previousVersion = getSetting("MissingE_previousVersion",'');
      request.target.page.dispatchMessage("all-settings",settings);
   }
   else if (request.name == "sidebarTweaks") {
      setSetting("MissingE_sidebarTweaks_accountNum",
                 request.message.accountNum);
   }
   else if (request.name == "tumblrPermission") {
      checkPermission(request,
                      getSetting("MissingE_postingTweaks_subEditRetries",MissingE.defaultRetries));
   }
   else if (request.name == "settings") {
      var settings = {};
      settings.component = request.message.component;
      var tumblrs = getSetting("MissingE_tumblrs",'');
      settings.tumblrAccounts = [];
      while (tumblrs.length > 0) {
         var len = tumblrs.indexOf(":");
         var acct = tumblrs.substring(0,len);
         tumblrs = tumblrs.substring(len+1);
         len = tumblrs.indexOf(",");
         if (len < 0) { len = tumblrs.length; }
         var acctTxt = tumblrs.substring(0,len);
         tumblrs = tumblrs.substring(len+1);
         acctTxt = acctTxt.replace(/%%/g,"%").replace(/%2C/g,",");
         settings.tumblrAccounts.push({account:acct,name:acctTxt});
      }
      switch(request.message.component) {
         case "konami":
            settings.active = getSetting("MissingE_konami_active",0);
            break;
         case "askTweaks":
            settings.scroll = getSetting("MissingE_askTweaks_scroll",1);
            settings.betterAnswers = getSetting("MissingE_askTweaks_betterAnswers",0);
            settings.tagAsker = getSetting("MissingE_askTweaks_tagAsker",1);
            settings.defaultTags = getSetting("MissingE_askTweaks_defaultTags",'');
            if (settings.defaultTags !== '') {
               settings.defaultTags = settings.defaultTags.replace(/, /g,',').split(',');
            }
            settings.askDash = getSetting("MissingE_askTweaks_askDash",0);
            settings.massDelete = getSetting("MissingE_askTweaks_massDelete",1);
            settings.adjustDomain = MissingE.isTumblrURL(request.target.url, ["messages"]);
            settings.photoReplies = getSetting("MissingE_askTweaks_photoReplies",1);
            settings.submissionControls = getSetting("MissingE_askTweaks_submissionControls",1);
            break;
         case "sidebarTweaks":
            settings.retries = getSetting("MissingE_sidebarTweaks_retries",MissingE.defaultRetries);
            settings.accountNum = getSetting("MissingE_sidebarTweaks_accountNum",0);
            settings.slimSidebar = getSetting("MissingE_sidebarTweaks_slimSidebar",0);
            settings.addSidebar = getSetting("MissingE_sidebarTweaks_addSidebar",0);
            settings.showTags = getSetting("MissingE_sidebarTweaks_showTags",0);
            break;
         case "bookmarker":
            settings.backupMarks = getSetting("MissingE_bookmarker_marks","");
            settings.format = getSetting("MissingE_bookmarker_format",MissingE.defaultFormat);
            settings.addBar = getSetting("MissingE_bookmarker_addBar",1);
            settings.keyboardShortcut = getSetting("MissingE_bookmarker_keyboardShortcut",1);
            break;
         case "dashboardTweaks":
            settings.reblogQuoteFit = getSetting("MissingE_dashboardTweaks_reblogQuoteFit",1);
            settings.wrapTags = getSetting("MissingE_dashboardTweaks_wrapTags",1);
            settings.replaceIcons = getSetting("MissingE_dashboardTweaks_replaceIcons",1);
            settings.textControls = getSetting("MissingE_dashboardTweaks_textControls",0);
            settings.smallIcons = getSetting("MissingE_dashboardTweaks_smallIcons",0);
            settings.postLinks = getSetting("MissingE_dashboardTweaks_postLinks",1);
            settings.reblogReplies = getSetting("MissingE_dashboardTweaks_reblogReplies",0);
            settings.widescreen = getSetting("MissingE_dashboardTweaks_widescreen",0);
            settings.queueArrows = getSetting("MissingE_dashboardTweaks_queueArrows",1);
            settings.noExpandAll = getSetting("MissingE_dashboardTweaks_noExpandAll",0);
            settings.massDelete = getSetting("MissingE_dashboardTweaks_massDelete",1);
            settings.randomQueue = getSetting("MissingE_dashboardTweaks_randomQueue",1);
            settings.sortableNotes = getSetting("MissingE_dashboardTweaks_sortableNotes",1);
            settings.notePreview = getSetting("MissingE_dashboardTweaks_notePreview",1);
            settings.simpleHighlight = getSetting("MissingE_dashboardTweaks_simpleHighlight",0);
            settings.pagedNav = getSetting("MissingE_dashboardTweaks_pagedNav",0);
            settings.keyboardShortcut = getSetting("MissingE_dashboardTweaks_keyboardShortcut",1);
            break;
         case "dashLinksToTabs":
            settings.newPostTabs = getSetting("MissingE_dashLinksToTabs_newPostTabs",1);
            settings.sidebar = getSetting("MissingE_dashLinksToTabs_sidebar",0);
            settings.reblogLinks = getSetting("MissingE_dashLinksToTabs_reblogLinks",0);
            settings.editLinks = getSetting("MissingE_dashLinksToTabs_editLinks",0);
            break;
         case "replyReplies":
            settings.showAvatars = getSetting("MissingE_replyReplies_showAvatars",1);
            settings.smallAvatars = getSetting("MissingE_replyReplies_smallAvatars",1);
            settings.addTags = getSetting("MissingE_replyReplies_addTags",1);
            settings.defaultTags = getSetting("MissingE_replyReplies_defaultTags",'');
            if (settings.defaultTags !== '') {
               settings.defaultTags = settings.defaultTags.replace(/, /g,',').split(',');
            }
            break;
         case "postCrushes":
            settings.prefix = getSetting("MissingE_postCrushes_prefix","Tumblr Crushes:");
            settings.crushSize = getSetting("MissingE_postCrushes_crushSize",1);
            settings.addTags = getSetting("MissingE_postCrushes_addTags",1);
            settings.showPercent = getSetting("MissingE_postCrushes_showPercent",1);
            break;
         case "postingTweaks":
            settings.photoReplies = getSetting("MissingE_postingTweaks_photoReplies",1);
            settings.addUploader = getSetting("MissingE_postingTweaks_addUploader",1);
            settings.quickButtons = getSetting("MissingE_postingTweaks_quickButtons",1);
            settings.blogSelect = getSetting("MissingE_postingTweaks_blogSelect",0);
            settings.tagQueuedPosts = getSetting("MissingE_postingTweaks_tagQueuedPosts",0);
            settings.queueTags = getSetting("MissingE_postingTweaks_queueTags",'');
            if (settings.queueTags !== '') {
               settings.queueTags = settings.queueTags.replace(/, /g,',').split(',');
            }
            settings.showAnswers = getSetting("MissingE_postingTweaks_showAnswers",0);
            settings.facebookOff = getSetting("MissingE_postingTweaks_facebookOff",0);
            settings.smartRedirect = getSetting("MissingE_postingTweaks_smartRedirect",0);
            break;
         case "magnifier":
            settings.magnifyAvatars = getSetting("MissingE_magnifier_magnifyAvatars",0);
            break;
         case "safeDash":
            settings.keyboardShortcut = getSetting("MissingE_safeDash_keyboardShortcut",1);
            break;
         case "betterReblogs":
            settings.passTags = getSetting("MissingE_betterReblogs_passTags",1);
            settings.autoFillTags = getSetting("MissingE_betterReblogs_autoFillTags",1);
            settings.quickReblog = getSetting("MissingE_betterReblogs_quickReblog",0);
            settings.accountName = '0';
            if (getSetting("MissingE_betterReblogs_quickReblogAcctType",0) == 1) {
               settings.accountName = getSetting("MissingE_betterReblogs_quickReblogAcctName",'0');
            }
            settings.quickReblogForceTwitter = getSetting("MissingE_betterReblogs_quickReblogForceTwitter","default");
            settings.quickReblogForceFacebook = getSetting("MissingE_betterReblogs_quickReblogForceFacebook","default");
            settings.quickReblogCaption = getSetting("MissingE_betterReblogs_quickReblogCaption",1);
            settings.fullText = getSetting("MissingE_betterReblogs_fullText",0);
            settings.tagQueuedPosts = (getSetting("MissingE_postingTweaks_enabled",1) == 1 && getSetting("MissingE_postingTweaks_tagQueuedPosts",0) == 1) ? 1: 0;
            settings.queueTags = getSetting("MissingE_postingTweaks_queueTags",'');
            if (settings.queueTags !== '') {
               settings.queueTags = settings.queueTags.replace(/, /g,',').split(',');
            }
            settings.tagReblogs = getSetting("MissingE_betterReblogs_tagReblogs",0);
            settings.reblogTags = getSetting("MissingE_betterReblogs_reblogTags",'');
            if (settings.reblogTags !== '') {
               settings.reblogTags = settings.reblogTags.replace(/, /g,',').split(',');
            }
            settings.reblogAsks = 0;//getSetting("MissingE_betterReblogs_reblogAsks",0);
            settings.quickKeyboardShortcut = getSetting("MissingE_betterReblogs_quickKeyboardShortcut",1);
            break;
      }
      request.target.page.dispatchMessage("settings",settings);
   }
   else if (request.name == "earlyStyles") {
      var injectStyles = [];

      if (getSetting("MissingE_askTweaks_enabled",1) == 1) {
         if (getSetting("MissingE_askTweaks_smallFanMail",0) == 1 &&
             MissingE.isTumblrURL(request.message.url, ["fanMail", "messages"])) {
            injectStyles.push({file: "core/askTweaks/smallFanMail.css"});
         }
         if (getSetting("MissingE_askTweaks_allFanMail",0) == 1 &&
             MissingE.isTumblrURL(request.message.url, ["messages"])) {
            injectStyles.push({file: "core/askTweaks/allFanMail.css"});
         }
      }

      if (MissingE.isTumblrURL(request.message.url, ["upload"]) &&
          MissingE.isTumblrURL(request.target.url,
                               ["dashboard", "blog", "likes", "tagged"])) {
         if (getSetting("MissingE_dashboardTweaks_enabled",1) == 1 &&
             getSetting("MissingE_dashboardTweaks_smallIcons",0) == 1) {
            request.target.page.dispatchMessage("earlyStyles",
                                                {styles: [{file: "core/dashboardTweaks/smallIcons.css"}]});
         }
         return;
      }

      if (MissingE.isTumblrURL(request.message.url,
                      ["dashboard",
                       "blog",
                       "blogData",
                       "drafts",
                       "queue",
                       "messages",
                       "likes",
                       "tagged"])) {

         injectStyles.push({code:
               '#posts .post .post_controls .MissingE_experimental_reply, ' +
               '#posts .post .post_controls .MissingE_experimental_reply_wait, ' +
               '#posts .post .post_controls .MissingE_experimental_reply_fail, ' +
               '#posts .post .post_controls .MissingE_experimental_reply_success, ' +
               '#posts .post .post_controls .MissingE_reblogYourself_retry, ' +
               '#posts .post .post_controls .MissingE_betterReblogs_retryAsk { ' +
                  'background-image:url("' +
                     safari.extension.baseURI  + "core/dashboardTweaks/postControls.png" +
                  '"); ' +
               '} ' +
               '#posts .post .post_controls .MissingE_quick_reblogging { ' +
                  'background-image:url("' +
                     safari.extension.baseURI + "core/betterReblogs/reblogging.gif" +
                  '") !important; ' +
               '} ' +
               '#posts .post .post_controls .MissingE_quick_reblogging_success { ' +
                  'background-image:url("' +
                     safari.extension.baseURI + "core/betterReblogs/reblogSuccess.png" +
                  '") !important; ' +
               '}'});

         if (getSetting("MissingE_dashboardTweaks_enabled",1) == 1) {
            injectStyles.push({file: "core/dashboardTweaks/dashboardTweaks.css"});
            if (getSetting("MissingE_dashboardTweaks_smallIcons",0) == 1) {
               injectStyles.push({file: "core/dashboardTweaks/smallIcons.css"});
            }
            if (getSetting("MissingE_dashboardTweaks_notePreview",1) == 1) {
               injectStyles.push({file: "core/dashboardTweaks/preview.css"});
               injectStyles.push({code:
                  '#MissingE_preview .previewIcon { ' +
                     'background-image:url("' +
                     safari.extension.baseURI + "core/dashboardTweaks/prevIcon.png" +
                     '"); ' +
                  '}' +
                  '#MissingE_preview.MissingE_preview_loading { ' +
                     'background-image:url("' +
                     safari.extension.baseURI + "core/dashboardTweaks/loader.gif" +
                     '");' +
                  '}' +
                  '#MissingE_preview.MissingE_preview_fail { ' +
                     'background-image:url("' +
                     safari.extension.baseURI + "core/dashboardTweaks/prevFail.png" +
                     '");' +
                  '}'});
            }
            if (getSetting("MissingE_dashboardTweaks_replaceIcons",1) == 1) {
               injectStyles.push({code:
                  '#posts .post .post_controls a[id^="ask_answer_link"], ' +
                  '#posts .post.fan_mail .controls a.reply_link, ' +
                  '#posts .post .post_controls a[href^="/edit"], ' +
                  '#dashboard_inbox .post .post_controls a[id^="post_delete_"], ' +
                  '#posts .post .post_controls a[onclick*="delete_post_"], ' +
                  '#posts .post .post_controls a[onclick*="queue_post"], ' +
                  '#posts .post .post_controls a[onclick*="approve_post"], ' +
                  '#posts .post .post_controls a[onclick*="publish_post"] { ' +
                     'background-image:url("' +
                        safari.extension.baseURI  + "core/dashboardTweaks/postControls.png" +
                     '"); ' +
                  '}'});
               injectStyles.push({file: "core/dashboardTweaks/replaceIcons.css"});
            }
            if (getSetting("MissingE_dashboardTweaks_textControls",0) == 1) {
               injectStyles.push({file: "core/dashboardTweaks/textControls.css"});
            }
            if (getSetting("MissingE_dashboardTweaks_reblogQuoteFit",1) == 1)
               injectStyles.push({file: "core/dashboardTweaks/reblogQuoteFit.css"});
            if (getSetting("MissingE_dashboardTweaks_wrapTags",1) == 1)
               injectStyles.push({file: "core/dashboardTweaks/wrapTags.css"});
            if (getSetting("MissingE_dashboardTweaks_postLinks",1) == 1)
               injectStyles.push({file: "core/dashboardTweaks/postLinks.css"});
            if (getSetting("MissingE_dashboardTweaks_massDelete",1) == 1 ||
                getSetting("MissingE_dashboardTweaks_randomQueue",1) == 1)
               injectStyles.push({file: "core/dashboardTweaks/draftQueueTools.css"});
            if (getSetting("MissingE_dashboardTweaks_sortableNotes",1) == 1)
               injectStyles.push({file: "core/dashboardTweaks/notesSorter.css"});
            if (getSetting("MissingE_dashboardTweaks_widescreen",0) == 1 &&
                !MissingE.isTumblrURL(request.message.url, ["settings"]))
               injectStyles.push({file: "core/dashboardTweaks/widescreen.css"});
            if (getSetting("MissingE_dashboardTweaks_queueArrows",1) == 1 &&
                MissingE.isTumblrURL(request.message.url, ["queue"]))
               injectStyles.push({file: "core/dashboardTweaks/queueArrows.css"});
            if (getSetting("MissingE_dashboardTweaks_simpleHighlight",0) == 1)
               injectStyles.push({file: "core/dashboardTweaks/simpleHighlight.css"});
         }

         if (getSetting("MissingE_safeDash_enabled",1) == 1) {
            injectStyles.push({file: "core/safeDash/safeDash.css"});
            if (getSetting("MissingE_safeDash_photosetAll",0) == 1) {
               injectStyles.push({file: "core/safeDash/photosetAll.css"});
            }
            injectStyles.push({code:
               '#right_column #MissingE_safeDash li a {' +
                  'background-image:url("' +
                  safari.extension.baseURI + "core/safeDash/lockicon.png" +
                  '") !important; ' +
               '} ' +
               'body.MissingE_safeDash #posts div.post.photo .post_content > div:first-child, ' +
               'body.MissingE_safeDash #posts div.post.photo .flipcard img, ' +
               'body.MissingE_safeDash #posts div.post.photo .photoset_photo, ' +
               'body.MissingE_safeDash #posts div.post.photo img.image_thumbnail, ' +
               'body.MissingE_safeDash #posts div.post.video .video_thumbnail, ' +
               'body.MissingE_safeDash #posts div.post.video .video_embed, ' +
               'body.MissingE_safeDash #posts div.post.video span[id^="video_player"], ' +
               'body.MissingE_safeDash #posts li.notification blockquote[style], ' +
               'body.MissingE_safeDash #posts div.post ol.notes blockquote.photo_container, ' +
               'body.MissingE_safeDash #posts div.post .post_content p .nsfw_span, ' +
               'body.MissingE_safeDash #posts div.post .post_content img.album_art, ' +
               'body.MissingE_safeDash #posts div.post .post_content img[onclick*="album_art"], ' +
               'body.MissingE_safeDash #posts div.post.video .tumblr_video_container { ' +
                  'background-image:url("' +
                  safari.extension.baseURI + "core/safeDash/lock.png" +
                  '");' +
               '}'});
         }

         if (getSetting("MissingE_askTweaks_enabled",1) == 1) {
            injectStyles.push({file: "core/askTweaks/askTweaks.css"});
         }
      }

      if (MissingE.isTumblrURL(request.message.url, ["massEditor"])) {
        if (getSetting("MissingE_massEditor_enabled",1) == 1) {
           if (getSetting("MissingE_massEditor_showNotes",1) == 1) {
              injectStyles.push({file: "core/massEditor/showNotes.css"});
           }
        }
      }

      if (MissingE.isTumblrURL(request.message.url,
                      ["dashboard",
                       "blog",
                       "tagged"])) {
         if (getSetting("MissingE_replyReplies_enabled",1) == 1) {
            injectStyles.push({code: "#posts .notification .notification_type_icon { background-image:url('" + safari.extension.baseURI + 'core/replyReplies/notification_icons.png' + "') !important; } #posts ol.notes .notification_type_icon { background-image:url('" + safari.extension.baseURI + 'core/replyReplies/notes_icons.png' + "') !important; }"});
            injectStyles.push({file: "core/replyReplies/replyReplies.css"});
         }
      }

      if (MissingE.isTumblrURL(request.message.url,
                      ["dashboard",
                       "blog",
                       "likes",
                       "tagged"])) {
         if (getSetting("MissingE_betterReblogs_enabled",1) == 1) {
            injectStyles.push({code: "#MissingE_quick_reblog #MissingE_qr_nipple { background-image:url('" + safari.extension.baseURI + 'core/betterReblogs/qrnipple.png' + "') !important; }"});
         }
      }

      request.target.page.dispatchMessage("earlyStyles", {styles: injectStyles});
   }
   else if (request.name == "start") {
      var activeScripts = {url: request.message.url};
      activeScripts.version = currVersion;
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url, ["dashboard", "messages"])) {
         activeScripts.getAccounts = true;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url, ["dashboardOnly"])) {
         activeScripts.warningInfo = true;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url, ["massEditor"])) {
         if (getSetting("MissingE_massEditor_enabled",1) == 1) {
            activeScripts.massEditor = true;
         }
         else
            activeScripts.massEditor = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url,
                               ["dashboard",
                                "blog",
                                "blogData",
                                "drafts",
                                "queue",
                                "messages",
                                "likes",
                                "tagged"])) {
         activeScripts.konami = true;

         if (getSetting("MissingE_safeDash_enabled",1) == 1) {
            activeScripts.safeDash = true;
         }
         else
            activeScripts.safeDash = false;

         if (getSetting("MissingE_dashLinksToTabs_enabled",1) == 1) {
            activeScripts.dashLinksToTabs = true;
         }
         else
            activeScripts.dashLinksToTabs = false;

         if (getSetting("MissingE_bookmarker_enabled",1) == 1) {
            activeScripts.bookmarker = true;
         }
         else
            activeScripts.bookmarker = false;

         if (getSetting("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.zindexFix = true;
         }

         if (getSetting("MissingE_sidebarTweaks_enabled",1) == 1) {
            activeScripts.sidebarTweaks = true;
         }
         else
            activeScripts.sidebarTweaks = false;

         if (getSetting("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.magnifier = true;
         }
         else
            activeScripts.magnifier = false;

         if (getSetting("MissingE_dashboardTweaks_enabled",1) == 1) {
            activeScripts.dashboardTweaks = true;
         }
         else
            activeScripts.dashboardTweaks = false;

         if (getSetting("MissingE_askTweaks_enabled",1) == 1) {
            activeScripts.askTweaks = true;
         }
         else
            activeScripts.askTweaks = false;
      }
      if (MissingE.isTumblrURL(request.message.url, ["askForm", "fanMail"])) {
         if (getSetting("MissingE_askTweaks_enabled",1)) {
            activeScripts.askTweaks = true;
         }
         else
            activeScripts.askTweaks = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url,
                               ["post",
                                "reblog",
                                "messages",
                                "queue",
                                "drafts"])) {
         if (getSetting("MissingE_postingTweaks_enabled",1) == 1) {
            activeScripts.postingTweaks = true;
         }
         else
            activeScripts.postingTweaks = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url, ["reblog"])) {
         if (getSetting("MissingE_betterReblogs_enabled",1) == 1) {
            activeScripts.betterReblogs = true;
            activeScripts.betterReblogs_fill = true;
         }
         else
            activeScripts.betterReblogs = false;

         if (getSetting("MissingE_reblogYourself_enabled",1) == 1) {
            activeScripts.reblogYourself = true;
            activeScripts.reblogYourself_fill = true;
         }
         else
            activeScripts.reblogYourself = false;
      }
      if (MissingE.isTumblrURL(request.message.url, ["iframe"]) &&
          !MissingE.isTumblrURL(request.target.url, ["post", "reblog"])) {
         if (getSetting("MissingE_gotoDashPost_enabled",1) == 1) {
            activeScripts.gotoDashPost = true;
         }
         else
            activeScripts.gotoDashPost = false;

         if (getSetting("MissingE_reblogYourself_enabled",1) == 1 &&
             getSetting("MissingE_reblogYourself_postPage",1) == 1) {
            activeScripts.reblogYourself = true;
         }
         else
            activeScripts.reblogYourself = false;

         if (getSetting("MissingE_betterReblogs_enabled",1) == 1 &&
             getSetting("MissingE_betterReblogs_passTags",1) == 1) {
            activeScripts.betterReblogs = true;
         }
         else
            activeScripts.betterReblogs = false;

         if (getSetting("MissingE_postingTweaks_enabled",1) == 1 &&
             getSetting("MissingE_postingTweaks_subEdit",1) == 1) {
            activeScripts.postingTweaks = true;
         }
         else
            activeScripts.postingTweaks = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url,
                               ["dashboard",
                                "blog",
                                "tagged"])) {
         if (getSetting("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            activeScripts.replyReplies_fill = false;
         }
         else
            activeScripts.replyReplies = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url, ["reply"])) {
         if (getSetting("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            activeScripts.replyReplies_fill = true;
         }
         else
            activeScripts.replyReplies = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url, ["following"])) {
         if (getSetting("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            activeScripts.postCrushes_fill = false;
         }
         else
            activeScripts.postCrushes = false;

         if (getSetting("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.zindexFix = true;
            activeScripts.magnifier = true;
         }
         else
            activeScripts.magnifier = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url, ["crushes"])) {
         if (getSetting("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            activeScripts.postCrushes_fill = true;
         }
         else
            activeScripts.postCrushes = false;
      }
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/(submissions|messages|inbox)/.test(request.message.url) ||
           /http:\/\/www\.tumblr\.com\/blog\/[^\/]*\/(submissions|messages)/.test(request.message.url))) {
         if (getSetting("MissingE_timestamps_enabled",1) == 1) {
            activeScripts.timestamps = true;
         }
         else
            activeScripts.timestamps = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url,
                      ["dashboard",
                       "blog",
                       "likes",
                       "messages",
                       "tagged"])) {
         if (getSetting("MissingE_timestamps_enabled",1) == 1) {
            activeScripts.timestamps = true;
         }
         else
            activeScripts.timestamps = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url,
                      ["dashboard",
                       "blog",
                       "likes",
                       "tagged"])) {
         if (getSetting("MissingE_betterReblogs_enabled",1) == 1) {
            if (getSetting("MissingE_betterReblogs_quickReblog",0) == 1) {
               activeScripts.zindexFix = true;
            }
            activeScripts.betterReblogs = true;
         }
         else
            activeScripts.betterReblogs = false;
      }
      if (!request.message.isFrame &&
          MissingE.isTumblrURL(request.message.url,
                      ["dashboard",
                       "blog",
                       "likes",
                       "tagged",
                       "drafts",
                       "queue",
                       "messages"])) {
         if (getSetting("MissingE_reblogYourself_enabled",1) == 1 &&
             getSetting("MissingE_reblogYourself_dashboard",1) == 1) {
            activeScripts.reblogYourself = true;
         }
         else
            activeScripts.reblogYourself = false;
      }

      activeScripts.url = request.message.url;
      activeScripts.isFrame = request.message.isFrame;
      request.target.page.dispatchMessage("startup",activeScripts);
   }
}

function collapseSettings(toPref, oldA, oldB) {
   var prefA = safari.extension.settings.getItem(oldA);
   var prefB = safari.extension.settings.getItem(oldB);
   var newPref = 0;

   if (prefA || prefB) {
      MissingE.log('"' + oldA + '" and "' + oldB + '" depracated. Moving settings to "' + toPref + '"');
   }
   if (prefA === 1 || prefB === 1) {
      newPref = 1;
   }
   if (prefA !== undefined || prefB !== undefined) {
      if (safari.extension.settings.getItem(toPref) === null) {
         safari.extension.settings[toPref] = newPref;
      }
      safari.extension.settings.removeItem(oldA);
      safari.extension.settings.removeItem(oldB);
   }
}

function clearSetting(pref) {
   safari.extension.settings.removeItem(pref);
}

function moveSetting(oldpref, newpref) {
   var pref, msg;
   if ((pref = safari.extension.settings.getItem(oldpref))) {
      msg = '"' + oldpref + '" depracated.';
      if (safari.extension.settings.getItem(newpref) === null) {
         msg += 'Moving setting to "' + newpref + '"';
         safari.extension.settings[newpref] = pref;
      }
      MissingE.log(msg);
      safari.extension.settings.removeItem(oldpref);
   }
}

function moveAllSettings(oldgroup, newgroup) {
   var re = new RegExp("^MissingE_" + oldgroup + "_");
   for (i in safari.extension.settings) {
      if (safari.extension.settings.hasOwnProperty(i) &&
          re.test(i)) {
         var newpref = i.replace(re,'MissingE_' + newgroup + '_');
         MissingE.log('"' + i + '" deprecated. Moving setting to "' + newpref + '"');
         if (safari.extension.settings.getItem(newpref) === null) {
            safari.extension.settings[newpref] = safari.extension.settings[i];
         }
         safari.extension.settings.removeItem(i);
      }
   }
}

function invertSetting(oldpref, newpref) {
   var pref;
   if ((pref = safari.extension.settings.getItem(oldpref))) {
      MissingE.log('"' + oldpref + '" changed to inverted setting "' + newpref + '"');
      if (safari.extension.settings.getItem(newPref) === null) {
         safari.extension.settings[newpref] = (pref === 1 ? 0 : 1);
      }
      safari.extension.settings.removeItem(oldpref);
   }
}

function settingChange(pref, from, to) {
   var val;
   var re = new RegExp("[" + from + "]", "g");
   if ((val = safari.extension.settings.getItem(pref))) {
      var newval = val.replace(re, to);
      if (newval !== val) {
         MissingE.log('"' + pref + '" changed from \'' + val + '\' to \'' + newval + '\'');
         safari.extension.settings[pref] = newval;
      }
   }
}

function getExternalVersion() {
   $.ajax({
      type: "GET",
      url: 'http://missing-e.com/version',
      dataType: "text",
      success: function(data, textStatus, xhr) {
         setSetting('MissingE_lastUpdateCheck', (new Date()).valueOf());
         var versionInfo = data.split(" ");
         versionInfo[versionInfo.length-1] =
            versionInfo[versionInfo.length-1].replace(/\s*$/m,'');
         setSetting('MissingE_externalVersion', versionInfo[0]);
         if (versionInfo.length > 1) {
            setSetting('MissingE_externalVersion_link', versionInfo[1]);
         }
         else {
            setSetting('MissingE_externalVersion_link', '');
         }
      }
   });
}

function injectSlimSidebar(e) {
   if (!e || e.key == "MissingE_sidebarTweaks_enabled" ||
       e.key == "MissingE_sidebarTweaks_slimSidebar") {
      if (getSetting("MissingE_sidebarTweaks_enabled",1) === 1 &&
          getSetting("MissingE_sidebarTweaks_slimSidebar",0) === 1 &&
          !hasSlimSidebar) {
         MissingE.debug("Adding slimSidebar CSS");
         hasSlimSidebar = true;
         safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI +
                                         "core/sidebarTweaks/slimSidebar.css",
                                         "http://www.tumblr.com/*");
      }
      else if (hasSlimSidebar) {
         var i;
         MissingE.debug("Removing slimSidebar CSS");
         hasSlimSidebar = false;
         safari.extension.removeContentStyleSheet(safari.extension.baseURI +
                                            "core/sidebarTweaks/slimSidebar.css");
         for (i=0; i<initialStyleSheets.length; i++) {
            safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI +
                                                         initialStyleSheets[i],
                                                         "http://www.tumblr.com/*");
            safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI +
                                                         "core/common/widenIframe.css",
                                                         "http://*");
         }
      }
   }
}

function fixupSettings() {
   moveAllSettings('askFixes','askTweaks');
   moveAllSettings('dashboardFixes','dashboardTweaks');
   moveAllSettings('postingFixes','postingTweaks');
   clearSetting('MissingE_postingTweaks_uploaderToggle');
   clearSetting('MissingE_experimentalFeatures_enabled');
   clearSetting('MissingE_sidebarTweaks_followingLink');
   clearSetting('MissingE_betterReblogs_keyboardShortcut');
   settingChange('MissingE_bookmarker_format',',;','.');
   invertSetting('MissingE_dashboardTweaks_expandAll','MissingE_dashboardTweaks_noExpandAll');
   moveSetting('MissingE_dashboardTweaks_slimSidebar','MissingE_sidebarTweaks_slimSidebar');
   moveSetting('MissingE_sidebarTweaks_showOverflowTags','MissingE_sidebarTweaks_showTags');
   collapseSettings('MissingE_askTweaks_betterAnswers','MissingE_askTweaks_buttons','MissingE_askTweaks_tags');
   invertSetting('MissingE_betterReblogs_noPassTags','MissingE_betterReblogs_passTags');
}

function getInitialStyleSheets() {
   var xhr = new XMLHttpRequest();
   xhr.open('GET', safari.extension.baseURI + 'Info.plist', false);
   xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
         var node, i;
         var list = xhr.responseXML.getElementsByTagName('key');
         for (i=0; i<list.length; i++) {
            if (list[i].firstChild.textContent === "Stylesheets") {
               node = list[i];
               break;
            }
         }
         if (!node) { return; }
         var arr = list[i].nextElementSibling.getElementsByTagName("string");
         for (i=0; i<arr.length; i++) {
            initialStyleSheets[i] = arr[i].firstChild.textContent;
         }
      }
   };
   xhr.send(null);
}

function onStart(currVersion, prevVersion) {
   if (prevVersion && prevVersion !== currVersion) {
      MissingE.log("Updated Missing e (" + prevVersion + " => " + currVersion + ")");
      setSetting('MissingE_previousVersion',prevVersion);
   }
   else if (!prevVersion) {
      MissingE.log("Installed Missing e " + currVersion);
      var options = safari.application.activeBrowserWindow.openTab().url =
         safari.extension.baseURI + "core/options.html";
      setSetting('MissingE_previousVersion',currVersion);
   }
   if (getSetting('MissingE_previousVersion','') == '') {
      setSetting('MissingE_previousVersion',currVersion);
   }
   setSetting('MissingE_installedVersion',currVersion);

   getInitialStyleSheets();
   injectSlimSidebar();
   safari.extension.settings.addEventListener("change", injectSlimSidebar, false);
   clearSetting('MissingE_konami_active');
}

safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI +
                                             "core/common/widenIframe.css",
                                             "http://*");

safari.extension.addContentScriptFromURL(safari.extension.baseURI +
                                         "extension.js",
                                         "http://*", null, true);
safari.extension.addContentScriptFromURL(safari.extension.baseURI +
                                         "core/utils.js",
                                         "http://*", null, true);
safari.extension.addContentScriptFromURL(safari.extension.baseURI +
                                         "core/betterReblogs/betterReblogs_post.js",
                                         "http://*", null, true);

onStart(currVersion, prevVersion);

if (!MissingE.isSameDay(getSetting('MissingE_lastUpdateCheck',0))) {
   MissingE.debug("Checking current available version.");
   getExternalVersion();
}
fixupSettings();
</script>
</head>
</html>
